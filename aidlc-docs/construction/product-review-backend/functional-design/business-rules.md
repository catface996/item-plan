# 业务规则 - 商品审核模块

## 1. 数据验证规则

### 1.1 商品数据验证

| 字段 | 规则 | 错误消息 |
|------|------|----------|
| name | 非空 | 商品名称不能为空 |
| name | 长度 1-100 | 商品名称长度必须在1-100字符之间 |
| description | 非空 | 商品描述不能为空 |
| description | 长度 1-1000 | 商品描述长度必须在1-1000字符之间 |
| price | 非空 | 商品价格不能为空 |
| price | 范围 0.01-999999.99 | 商品价格必须在0.01-999999.99之间 |

### 1.2 审核数据验证

| 字段 | 规则 | 错误消息 |
|------|------|----------|
| result | 非空 | 审核结果不能为空 |
| result | 枚举值 | 审核结果必须是 PASS/REJECT/NEED_MODIFY |
| comment | 条件必填 | 拒绝或需修改时必须填写审核意见 |
| comment | 长度 0-500 | 审核意见长度不能超过500字符 |

### 1.3 用户数据验证

| 字段 | 规则 | 错误消息 |
|------|------|----------|
| username | 非空 | 用户名不能为空 |
| username | 长度 3-50 | 用户名长度必须在3-50字符之间 |
| username | 唯一 | 用户名已存在 |
| password | 非空 | 密码不能为空 |
| password | 长度 >= 6 | 密码长度不能少于6位 |

---

## 2. 状态转换规则

### 2.1 允许的状态转换

| 当前状态 | 允许转换到 | 触发条件 |
|----------|------------|----------|
| PENDING | FIRST_PASS | 初审通过 |
| PENDING | REJECTED | 初审拒绝 |
| PENDING | NEED_MODIFY | 初审需修改 |
| FIRST_PASS | APPROVED | 复审通过 |
| FIRST_PASS | REJECTED | 复审拒绝 |
| FIRST_PASS | NEED_MODIFY | 复审需修改 |
| NEED_MODIFY | PENDING | 商家重新提交 |

### 2.2 禁止的状态转换

| 当前状态 | 禁止转换到 | 原因 |
|----------|------------|------|
| APPROVED | 任何状态 | 终态，不可变更 |
| REJECTED | 任何状态 | 终态，不可变更 |
| PENDING | APPROVED | 必须经过两级审核 |
| FIRST_PASS | PENDING | 不能回退到待审核 |

---

## 3. 权限规则

### 3.1 角色权限矩阵

| 操作 | MERCHANT | REVIEWER | SENIOR_REVIEWER |
|------|----------|----------|-----------------|
| 创建商品 | ✅ | ❌ | ❌ |
| 查看自己的商品 | ✅ | ❌ | ❌ |
| 修改被退回商品 | ✅ | ❌ | ❌ |
| 查看待审核列表 | ❌ | ✅ | ❌ |
| 执行初审 | ❌ | ✅ | ❌ |
| 查看待复审列表 | ❌ | ❌ | ✅ |
| 执行复审 | ❌ | ❌ | ✅ |
| 查看审核统计 | ❌ | ❌ | ✅ |
| 查看审核历史 | ❌ | ✅ | ✅ |

### 3.2 数据访问规则

| 规则ID | 描述 |
|--------|------|
| DR-001 | 商家只能查看和修改自己提交的商品 |
| DR-002 | 审核员只能审核非自己提交的商品 |
| DR-003 | 审核记录对所有审核员可见 |

---

## 4. 业务约束

### 4.1 审核流程约束

| 约束ID | 描述 |
|--------|------|
| BC-001 | 商品必须经过初审和复审两级审核才能通过 |
| BC-002 | 同一商品不能被同一审核员重复审核 |
| BC-003 | 审核意见在拒绝或需修改时必填 |
| BC-004 | 商品被退回后重新提交，保留所有历史审核记录 |

### 4.2 数据完整性约束

| 约束ID | 描述 |
|--------|------|
| DI-001 | 商品必须关联有效的商家 |
| DI-002 | 审核记录必须关联有效的商品和审核员 |
| DI-003 | 删除商家时，其商品不自动删除（软删除策略） |

### 4.3 并发控制约束

| 约束ID | 描述 |
|--------|------|
| CC-001 | 同一商品同一时间只能被一个审核员审核 |
| CC-002 | 商品状态更新使用乐观锁防止并发冲突 |

---

## 5. 错误处理规则

### 5.1 业务异常

| 异常代码 | 描述 | HTTP状态码 |
|----------|------|------------|
| PRODUCT_NOT_FOUND | 商品不存在 | 404 |
| INVALID_STATUS | 商品状态不允许此操作 | 400 |
| PERMISSION_DENIED | 无权限执行此操作 | 403 |
| VALIDATION_ERROR | 数据验证失败 | 400 |
| DUPLICATE_AUDIT | 不能重复审核同一商品 | 400 |

### 5.2 系统异常

| 异常代码 | 描述 | HTTP状态码 |
|----------|------|------------|
| INTERNAL_ERROR | 系统内部错误 | 500 |
| DATABASE_ERROR | 数据库操作失败 | 500 |
| CONCURRENT_MODIFICATION | 并发修改冲突 | 409 |
